// Module included in the following assemblies:
// * edge_computing/image-based-upgrade/cnf-image-based-upgrade-base.adoc

:_mod-docs-content-type: PROCEDURE
[id="ztp-image-based-upgrading-with-backup_{context}"]
= Moving to the Upgrade stage of the image-based upgrade with {lcao}

Once you generated the seed image and completed the `Prep` stage, you can upgrade the target cluster.
During the upgrade process, the OADP Operator creates a backup of the artifacts specified in the OADP CRs, then the {lcao} upgrades the cluster.

If the upgrade fails or stops, an automatic rollback is initiated.
If you have an issue after the upgrade, you can initiate a manual rollback.
For more information about manual rollback, see "(Optional) Initiating a rollback with {lcao}".

.Prerequisites

* Complete the `Prep` stage.

.Procedure

. When you are ready, move to the upgrade stage by changing the value of the `stage` field to `Upgrade` in the `ImageBasedUpgrade` CR.
+
[source,terminal]
----
$ oc patch imagebasedupgrades.lca.openshift.io upgrade -p='{"spec": {"stage": "Upgrade"}}' --type=merge
----

. Check the status of the `ImageBasedUpgrade` CR:
+
--
[source,terminal]
----
$ oc get ibu -A -oyaml
----

.Example output
[source,yaml]
----
status:
  conditions:
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: In progress
    observedGeneration: 5
    reason: InProgress
    status: "False"
    type: Idle
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: Prep completed
    observedGeneration: 5
    reason: Completed
    status: "False"
    type: PrepInProgress
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: Prep completed successfully
    observedGeneration: 5
    reason: Completed
    status: "True"
    type: PrepCompleted
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: |-
      Waiting for system to stabilize: one or more health checks failed
        - one or more ClusterOperators not yet ready: authentication
        - one or more MachineConfigPools not yet ready: master
        - one or more ClusterServiceVersions not yet ready: sriov-fec.v2.8.0
    observedGeneration: 1
    reason: InProgress
    status: "True"
    type: UpgradeInProgress
  observedGeneration: 1
  rollbackAvailabilityExpiration: "2024-05-19T14:01:52Z"
  validNextStages:
  - Rollback
----
--

. The OADP Operator creates a backup of the data specified in the OADP `Backup` and `Restore` CRs.

. The target cluster reboots.

. Monitor the status of the CR:
+
[source,terminal]
----
$ oc get ibu -A -oyaml
----

. The cluster reboots.

. Once you are satisfied with the upgrade, commit to the changes by changing the value of the `stage` field to `Idle` in the `ImageBasedUpgrade` CR:
+
--
[source,terminal]
----
$ oc patch imagebasedupgrades.lca.openshift.io upgrade -p='{"spec": {"stage": "Idle"}}' --type=merge
----

[IMPORTANT]
====
You cannot roll back the changes once you move to the `Idle` stage after an upgrade.
====

The {lcao} deletes all resources created during the upgrade process.
--

.Verification

. Check the status of the `ImageBasedUpgrade` CR:
+
--
[source,terminal]
----
$ oc get ibu -A -oyaml
----

.Example output
[source,yaml]
----
status:
  conditions:
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: In progress
    observedGeneration: 5
    reason: InProgress
    status: "False"
    type: Idle
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: Prep completed
    observedGeneration: 5
    reason: Completed
    status: "False"
    type: PrepInProgress
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: Prep completed successfully
    observedGeneration: 5
    reason: Completed
    status: "True"
    type: PrepCompleted
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: Upgrade completed
    observedGeneration: 1
    reason: Completed
    status: "False"
    type: UpgradeInProgress
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: Upgrade completed
    observedGeneration: 1
    reason: Completed
    status: "True"
    type: UpgradeCompleted
  observedGeneration: 1
  rollbackAvailabilityExpiration: "2024-01-01T09:00:00Z"
  validNextStages:
  - Idle
  - Rollback
----
--

. Check the status of the cluster restoration:
+
--
[source,terminal]
----
$ oc get restores -n openshift-adp -o custom-columns=NAME:.metadata.name,Status:.status.phase,Reason:.status.failureReason
----

.Example output
[source,terminal]
----
NAME             Status      Reason
acm-klusterlet   Completed   <none> <1>
apache-app       Completed   <none>
localvolume      Completed   <none>
----
<1> The `acm-klusterlet` is specific to {rh-rhacm} environments only.
--